const translations = {
    en: {
        loader_status: "Initializing System",
        available: "Available",
        nav_work: "Work",
        nav_about: "About",
        nav_services: "Services",
        nav_talk: "Let's talk",
        nav_contact: "Contact",
        hero_tag: "Freelance",
        hero_status: "Available for hire",
        hero_btn: "See Projects",
        work_title: "Selected Work",
        view_archive: "View Full Archive",
        view_label: "VIEW",
        process_title: "Process",
        process_subtitle: "(The Workflow)",
        step1_title: "Strategy & Discovery",
        step1_desc: "Deep-diving into your brand's DNA, market position, and user needs to create a bulletproof digital blueprint.",
        step2_title: "Creative Design",
        step2_desc: "Translating strategy into stunning, high-fidelity UI/UX that prioritizes aesthetic excellence and intuitive interaction.",
        step3_title: "Technical Build",
        step3_desc: "Engineering accessible, high-performance frontend code using modern tech stacks like React, Next.js, and GSAP.",
        step4_title: "Launch & Scale",
        step4_desc: "Performance tuning, SEO implementation, and final staging to ensure a flawless, high-speed digital launch.",
        step1_detail1: "Market Research",
        step1_detail2: "User Personas",
        step1_detail3: "Project Roadmap",
        step2_detail1: "Visual Identity",
        step2_detail2: "Prototyping",
        step2_detail3: "Motion Design",
        step3_detail1: "Clean Architecture",
        step3_detail2: "API Integration",
        step3_detail3: "Responsive Logic",
        step4_detail1: "Speed Tuning",
        step4_detail2: "SEO Excellence",
        step4_detail3: "Testing & QA",
        about_title: "About",
        about_subtitle: "(The Creator)",
        about_lead: "A multidisciplinary developer and designer crafting high-end digital experiences that merge technical precision with creative vision.",
        about_p1: "Based in Cairo, I bridge the gap between aesthetics and functionality. I believe the web is more than just a tool—it's a canvas for storytelling and human connection.",
        about_p2: "My approach combines a deep understanding of frontend engineering with a keen eye for minimalist design, ensuring every pixel serves a purpose and every interaction feels intuitive.",
        phi1_title: "Design with Purpose",
        phi1_desc: "Every element should solve a problem or enhance the user's journey.",
        phi2_title: "Build for Performance",
        phi2_desc: "Speed and clean code are the foundation of a premium web experience.",
        stat_exp: "Years of Experience",
        stat_projects: "Projects Completed",
        expertise_title: "Core Expertise",
        skill1_title: "Technical Architecture",
        skill1_desc: "Engineering high-performance, accessible digital products with React, Next.js, and specialized animation pipelines. Focused on clean code and system scalability.",
        performance: "Performance",
        skill2_title: "Visual Identity",
        skill2_desc: "Pixel-perfect UI/UX design with a focus on immersive aesthetics and human-centered motion.",
        skill3_title: "Product Strategy",
        skill3_desc: "Bridging the gap between business goals and user needs through data-driven design audits.",
        contact_title: "Get in touch",
        contact_subtitle: "(Contact)",
        contact_lead: "Have a project in mind? Let's build something great together.",
        available_projects: "Available for new projects",
        send_message: "Send a Message",
        respond_time: "I usually respond within 24 hours.",
        form_name: "Name",
        form_email: "Email",
        form_subject: "Subject",
        form_message: "Message",
        placeholder_name: "John Doe",
        placeholder_email: "john@example.com",
        placeholder_subject: "Project Inquiry",
        placeholder_message: "Tell me about your project...",
        send_btn: "Send Message",
        services_title: "Services",
        services_subtitle: "(What I Do)",
        service1_title: "Web Design",
        service1_short: "Aesthetic digital experiences.",
        service1_desc: "Crafting visually compelling and user-centric digital interfaces that tell your brand's unique story through modern aesthetics and purposeful design.",
        service2_title: "Development",
        service2_short: "High-performance solutions.",
        service2_desc: "Building high-performance, scalable web applications with clean code and cutting-edge technologies. Focused on speed, security, and accessibility.",
        service3_title: "UI/UX Design",
        service3_short: "User-centered interfaces.",
        service3_desc: "Designing intuitive user journeys and interfaces that prioritize accessibility and seamless interaction across all devices and platforms.",
        service4_title: "Branding",
        service4_short: "Cohesive visual identity.",
        service4_desc: "Creating cohesive visual identities that resonate with your audience and build lasting brand authority through strategic design and storytelling.",
        start_project: "Start a Project",
        local_time: "Local Time:",
        cairo_eg: "Cairo, EG",
        footer_slogan1: "Designed with class.",
        footer_slogan2: "Built to last.",
        footer_tagline: "Designing experiences that resonate. Building solutions that last.",
        footer_nav_label: "Navigation",
        privacy: "Privacy Policy",
        terms: "Terms of Service",
        copyright: "© 2025 Adham Eldeeb. Credits to inspiration.",
        adham_name: "ADHAM ELDEEB",
        back_to_top: "Back to top",
        close_case: "Close Case Study",
        opt_landing: "Landing Page ($1,000)",
        opt_corp: "Corporate Website ($2,500)",
        opt_ecommerce: "E-commerce ($5,000)",
        opt_webapp: "Web Application ($8,000)",
        label_pages: "Number of Pages",
        plus_page: "(+$100/page)",
        label_total: "Estimated Cost:",
        label_email: "Email me",
        label_location: "Location",
        label_social: "Social",
        cairo_world: "Cairo, Egypt / Remote Worldwide",
        tag_art: "Art Direction",
        tag_story: "Visual Storytelling",
        tag_resp: "Responsive Layouts",
        tag_next: "React / Next.js",
        tag_custom: "Custom Code",
        tag_api: "API Integration",
        tag_research: "User Research",
        tag_proto: "Prototyping",
        tag_design: "Design Systems",
        tag_logo: "Logo Design",
        tag_color: "Color Schemes",
        tag_brand: "Brand Strategy",
        loader_msg1: "Calibrating Interface",
        loader_msg2: "Fetching Assets",
        loader_msg3: "Rendering Components",
        loader_msg4: "Finalizing Staging",
        loader_msg5: "System Ready",
        error_title: "Endpoint Not Found",
        error_message: "The page you're looking for was either moved, deleted, or never existed in this dimension.",
        error_btn: "Back to Reality"
    },
    ar: {
        loader_status: "جاري تشغيل النظام",
        available: "متاح للعمل",
        nav_work: "أعمالي",
        nav_about: "عني",
        nav_services: "خدماتي",
        nav_talk: "تواصل معي",
        nav_contact: "اتصل بي",
        hero_tag: "عمل حر",
        hero_status: "متاح للعمل",
        hero_btn: "شاهد أعمالي",
        work_title: "أعمال مختارة",
        view_archive: "مشاهدة الأرشيف الكامل",
        process_title: "طريقة العمل",
        process_subtitle: "(الأسلوب)",
        step1_title: "الاستراتيجية والاكتشاف",
        step1_desc: "الغوص العميق في هوية علامتك التجارية، ومركزك في السوق، واحتياجات المستخدمين لإنشاء مخطط رقمي قوي.",
        step2_title: "التصميم الإبداعي",
        step2_desc: "ترجمة الاستراتيجية إلى واجهات مستخدم مذهلة وعالية الدقة تعطي الأولوية للتميز الجمالي والتفاعل البديهي.",
        step3_title: "البناء الفني",
        step3_desc: "هندسة أكواد برمجية سهلة الوصول وعالية الأداء باستخدام أدوات حديثة مثل React و Next.js و GSAP.",
        step4_title: "الإطلاق والتطوير",
        step4_desc: "ضبط الأداء، وتنفيذ تحسين محركات البحث، والتهيئة النهائية لضمان إطلاق رقمي سريع وخالٍ من الأخطاء.",
        step1_detail1: "بحث السوق",
        step1_detail2: "ملفات المستخدمين",
        step1_detail3: "خارطة طريق المشروع",
        step2_detail1: "الهوية البصرية",
        step2_detail2: "النماذج الأولية",
        step2_detail3: "تصميم الحركة",
        step3_detail1: "هندسة برمجية نظيفة",
        step3_detail2: "دمج واجهة البرمجة",
        step3_detail3: "منطق التجاوب",
        step4_detail1: "ضبط السرعة",
        step4_detail2: "تميز محركات البحث",
        step4_detail3: "الاختبار والجودة",
        about_title: "عني",
        about_subtitle: "(المبدع)",
        about_lead: "مطور ومصمم متعدد التخصصات يصمم تجارب رقمية راقية تدمج الدقة التقنية مع الرؤية الإبداعية.",
        about_p1: "مقرّي في القاهرة، وأنا أعمل على سد الفجوة بين الجماليات والوظائف. أؤمن بأن الويب أكثر من مجرد أداة - إنه لوحة لسرد القصص والتواصل البشري.",
        about_p2: "يجمع نهجي بين الفهم العميق لهندسة الواجهات الأمامية وبين العين الثاقبة للتصميم البسيط، مما يضمن أن كل بكسل يخدم غرضاً وأن كل تفاعل يبدو بديهياً.",
        phi1_title: "التصميم الهادف",
        phi1_desc: "يجب أن يحل كل عنصر مشكلة أو يحسن رحلة المستخدم.",
        phi2_title: "البناء للأداء",
        phi2_desc: "السرعة والكود النظيف هما أساس تجربة الويب المتميزة.",
        stat_exp: "سنوات الخبرة",
        stat_projects: "مشاريع مكتملة",
        expertise_title: "الخبرات الأساسية",
        skill1_title: "الهندسة التقنية",
        skill1_desc: "هندسة منتجات رقمية عالية الأداء وسهلة الوصول باستخدام React و Next.js وأنابيب رسوم متحركة متخصصة. التركيز على الكود النظيف وقابلية توسع النظام.",
        performance: "الأداء",
        skill2_title: "الهوية البصرية",
        skill2_desc: "تصميم واجهة مستخدم/تجربة مستخدم مثالي مع التركيز على الجماليات الغامرة والحركة التي تتمحور حول الإنسان.",
        skill3_title: "استراتيجية المنتج",
        skill3_desc: "سد الفجوة بين أهداف العمل واحتياجات المستخدم من خلال عمليات تدقيق التصميم القائمة على البيانات.",
        contact_title: "تواصل معي",
        contact_subtitle: "(اتصال)",
        contact_lead: "لديك مشروع في ذهنك؟ لنبني شيئاً رائعاً معاً.",
        available_projects: "متاح للمشاريع الجديدة",
        send_message: "أرسل رسالة",
        respond_time: "أقوم بالرد عادةً في غضون 24 ساعة.",
        form_name: "الاسم",
        form_email: "البريد الإلكتروني",
        form_subject: "الموضوع",
        form_message: "الرسالة",
        placeholder_name: "جون دو",
        placeholder_email: "john@example.com",
        placeholder_subject: "استفسار عن مشروع",
        placeholder_message: "أخبرني عن مشروعك...",
        send_btn: "إرسال الرسالة",
        services_title: "الخدمات",
        services_subtitle: "(ماذا أفعل)",
        service1_title: "تصميم المواقع",
        service1_short: "تجارب رقمية جمالية.",
        service1_desc: "صياغة واجهات رقمية جذابة بصرياً وتتمحور حول المستخدم تحكي قصة علامتك التجارية الفريدة من خلال الجماليات الحديثة والتصميم الهادف.",
        service2_title: "التطوير",
        service2_short: "حلول عالية الأداء.",
        service2_desc: "بناء تطبيقات ويب عالية الأداء وقابلة للتوسع بأكواد نظيفة وتقنيات متطورة. التركيز على السرعة والأمان وسهولة الوصول.",
        service3_title: "تصميم واجهة وتجربة المستخدم",
        service3_short: "واجهات تتمحور حول المستخدم.",
        service3_desc: "تصميم رحلات مستخدم وواجهات بديهية تعطي الأولوية لسهولة الوصول والتفاعل السلس عبر جميع الأجهزة والمنصات.",
        service4_title: "الهوية التجارية",
        service4_short: "هوية بصرية متماسكة.",
        service4_desc: "إنشاء هويات بصرية متماسكة تلقى صدى لدى جمهورك وتبني سلطة علامة تجارية دائمة من خلال التصميم الاستراتيجي وسرد القصص.",
        start_project: "ابدأ مشروعاً",
        local_time: "الوقت المحلي:",
        cairo_eg: "القاهرة، مصر",
        footer_slogan1: "صمم برقي.",
        footer_slogan2: "بني ليدوم.",
        footer_tagline: "تصميم تجارب تترك أثراً. بناء حلول تدوم طويلاً.",
        footer_nav_label: "التنقل",
        privacy: "سياسة الخصوصية",
        terms: "شروط الخدمة",
        copyright: "© 2025 أدهم الديب. حقوق الإلهام محفوظة.",
        adham_name: "أدهم الديب",
        back_to_top: "العودة للأعلى",
        close_case: "إغلاق نافذة المشروع",
        opt_landing: "صفحة هبوط (١٠٠٠$)",
        opt_corp: "موقع شركة (٢٥٠٠$)",
        opt_ecommerce: "متجر إلكتروني (٥٠٠٠$)",
        opt_webapp: "تطبيق ويب (٨٠٠٠$)",
        label_pages: "عدد الصفحات",
        plus_page: "(+١٠٠$/للصفحة)",
        label_total: "التكلفة التقديرية:",
        page_singular: "صفحة",
        page_plural: "صفحات",
        label_email: "أرسل بريداً",
        label_location: "الموقع",
        label_social: "التواصل",
        cairo_world: "القاهرة، مصر / عن بعد في جميع أنحاء العالم",
        tag_art: "التوجه الفني",
        tag_story: "سرد القصص البصري",
        tag_resp: "تخطيطات متجاوبة",
        tag_next: "React / Next.js",
        tag_custom: "كود مخصص",
        tag_api: "دمج واجهة البرمجة",
        tag_research: "بحث المستخدم",
        tag_proto: "نماذج أولية",
        tag_design: "أنظمة التصميم",
        tag_logo: "تصميم الشعار",
        tag_color: "مخططات الألوان",
        tag_brand: "استراتيجية العلامة",
        loader_msg1: "جاري معايرة الواجهة",
        loader_msg2: "جاري جلب الأصول",
        loader_msg3: "جاري تحميل المكونات",
        loader_msg4: "اللمسات النهائية",
        loader_msg5: "النظام جاهز",
        error_title: "الصفحة غير موجودة",
        error_message: "الصفحة التي تبحث عنها قد تم نقلها، حذفها، أو أنها لم توجد أبداً في هذا البعد.",
        error_btn: "العودة إلى الواقع",
        view_label: "مشاهدة"
    }
};

let currentLang = localStorage.getItem('preferredLang') || 'en';
const isMouseDevice = window.matchMedia('(hover: hover) and (pointer: fine)').matches;

const slides = {
    en: [
        {
            title: ['WEB', 'DEVEL', 'OPER'],
            styles: ['solid', 'outline', 'solid'],
            description: "A freelance web developer based in Egypt. Specializing in modern frontend technologies and creative coding, I build immersive and performant web experiences.",
            gradient: "linear-gradient(180deg, #ffffff 0%, #f0f4e1 100%)",
            meshColors: "radial-gradient(circle at 70% 30%, rgba(196, 214, 0, 0.2) 0%, transparent 50%), radial-gradient(circle at 30% 70%, rgba(0, 0, 0, 0.05) 0%, transparent 50%)",
            image: "download.png"
        },
        {
            title: ['Pro', 'blem', 'SOLVER'],
            styles: ['solid', 'solid', 'highlight'],
            description: "Crafting intuitive and accessible user interfaces. I focus on user-centered design principles to create digital products that are easy to use.",
            gradient: "linear-gradient(180deg, #ffffff 0%, #fff0f0 100%)",
            meshColors: "radial-gradient(circle at 70% 30%, rgba(255, 107, 107, 0.15) 0%, transparent 50%), radial-gradient(circle at 30% 70%, rgba(0, 0, 0, 0.05) 0%, transparent 50%)",
            image: "download.png"
        },
        {
            title: ['CREA', 'TIVE', 'CODER'],
            styles: ['outline', 'solid', 'highlight'],
            description: "Pushing the boundaries to create unique web experiences that are both functional and immersive. Every pixel is crafted with intent.",
            gradient: "linear-gradient(180deg, #ffffff 0%, #f0fafa 100%)",
            meshColors: "radial-gradient(circle at 70% 30%, rgba(78, 205, 196, 0.15) 0%, transparent 50%), radial-gradient(circle at 30% 70%, rgba(0, 0, 0, 0.05) 0%, transparent 50%)",
            image: "download.png"
        }
    ],
    ar: [
        {
            title: ['مطور', 'ويب', 'مبدع'],
            styles: ['solid', 'outline', 'solid'],
            description: "مطور مواقع مستقل مقيم في مصر. متخصص في تقنيات الواجهات الأمامية الحديثة والبرمجة الإبداعية، أقوم ببناء تجارب ويب غامرة وعالية الأداء.",
            gradient: "linear-gradient(180deg, #ffffff 0%, #f0f4e1 100%)",
            meshColors: "radial-gradient(circle at 70% 30%, rgba(196, 214, 0, 0.2) 0%, transparent 50%), radial-gradient(circle at 30% 70%, rgba(0, 0, 0, 0.05) 0%, transparent 50%)",
            image: "download.png"
        },
        {
            title: ['حلول', 'رقمية', 'راقية'],
            styles: ['solid', 'solid', 'highlight'],
            description: "صياغة واجهات مستخدم بديهية وسهلة الوصول. أركز على مبادئ التصميم التي تمحور حول المستخدم لإنشاء منتجات رقمية سهلة الاستخدام.",
            gradient: "linear-gradient(180deg, #ffffff 0%, #fff0f0 100%)",
            meshColors: "radial-gradient(circle at 70% 30%, rgba(255, 107, 107, 0.15) 0%, transparent 50%), radial-gradient(circle at 30% 70%, rgba(0, 0, 0, 0.05) 0%, transparent 50%)",
            image: "download.png"
        },
        {
            title: ['تميز', 'في', 'التنفيذ'],
            styles: ['outline', 'solid', 'highlight'],
            description: "تجاوز الحدود لإنشاء تجارب ويب فريدة من نوعها وظيفية وغامرة في نفس الوقت. يتم صياغة كل بكسل بهدف.",
            gradient: "linear-gradient(180deg, #ffffff 0%, #f0fafa 100%)",
            meshColors: "radial-gradient(circle at 70% 30%, rgba(78, 205, 196, 0.15) 0%, transparent 50%), radial-gradient(circle at 30% 70%, rgba(0, 0, 0, 0.05) 0%, transparent 50%)",
            image: "download.png"
        }
    ]
};


// Initialize Lenis Smooth Scroll
const lenis = new Lenis({
    duration: 1.5, // Increased for a more "liquid" feel
    easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
    direction: 'vertical',
    gestureDirection: 'vertical',
    smooth: true,
    mouseMultiplier: 1,
    smoothTouch: true, // Enable for mobile/tablet smoothness
    touchMultiplier: 1.5,
    infinite: false,
});

function raf(time) {
    lenis.raf(time);
    requestAnimationFrame(raf);
}

requestAnimationFrame(raf);

let currentIndex = 0;
const heroTitle = document.getElementById('heroTitle');
const heroDescription = document.getElementById('heroDescription');
const indicators = document.querySelectorAll('.indicator');
const body = document.body;

function updateSlide(index) {
    if (!slides[currentLang] || !slides[currentLang][index]) return;
    const slide = slides[currentLang][index];
    const heroTitleEl = document.getElementById('heroTitle');
    if (!heroTitleEl) return;
    const lines = heroTitleEl.querySelectorAll('.line');
    lines.forEach((line, i) => {
        const span = line.querySelector('span');
        if (span) {
            span.style.transform = 'translateY(100%)';
            setTimeout(() => {
                // Update text and remove old style classes
                span.textContent = slide.title[i] || '';
                line.classList.remove('is-outline', 'is-highlight', 'is-solid');

                // Apply new style class
                if (slide.styles[i] === 'outline') line.classList.add('is-outline');
                if (slide.styles[i] === 'highlight') line.classList.add('is-highlight');

                // Trigger reveal
                span.style.transform = 'translateY(0)';
            }, 400 + (i * 100));
        }
    });

    // Update Marquee based on title
    const marqueeItems = document.querySelectorAll('.marquee-item');
    marqueeItems.forEach(item => {
        item.style.opacity = '0';
        setTimeout(() => {
            item.textContent = slide.title.join(' ');
            item.style.opacity = '1';
        }, 500);
    });

    // Update Description
    const heroDescription = document.querySelector('.hero-description p');
    if (heroDescription) {
        heroDescription.style.opacity = '0';
        setTimeout(() => {
            heroDescription.textContent = slide.description;
            heroDescription.style.opacity = '1';
        }, 300);
    }

    // Update Image
    const heroImage = document.getElementById('heroImage');
    if (heroImage) {
        heroImage.style.opacity = '0';
        heroImage.style.transform = 'scale(0.95)';
        setTimeout(() => {
            heroImage.src = slide.image;
            heroImage.style.opacity = '1';
            heroImage.style.transform = 'scale(1)';
        }, 300);
    }

    // Update Background Gradients
    body.style.background = slide.gradient;

    // Update Mesh Gradient Colors
    const mesh = document.querySelector('.mesh-gradient');
    if (mesh) {
        mesh.style.background = slide.meshColors;
    }

    // Update Indicators
    const indicators = document.querySelectorAll('.indicator');
    indicators.forEach(ind => ind.classList.remove('active'));
    if (indicators[index]) indicators[index].classList.add('active');

    currentIndex = index;
}

// Initial update to apply slide 0 gradient and state
updateSlide(currentIndex);

// Auto-play
let interval = setInterval(() => {
    let nextIndex = (currentIndex + 1) % slides[currentLang].length;
    updateSlide(nextIndex);
}, 5000);

// Click Handlers
if (indicators && indicators.length > 0) {
    indicators.forEach(indicator => {
        indicator.addEventListener('click', () => {
            clearInterval(interval); // Stop auto-play on interaction
            const index = parseInt(indicator.dataset.index);
            updateSlide(index);

            // Restart auto-play after 10s
            interval = setInterval(() => {
                let nextIndex = (currentIndex + 1) % slides[currentLang].length;
                updateSlide(nextIndex);
            }, 10000);
        });
    });
}

// Scroll Animations
const observerOptions = {
    root: null,
    rootMargin: '0px',
    threshold: 0.1
};

const observer = new IntersectionObserver((entries, observer) => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            entry.target.classList.add('is-visible');
            // Don't unobserve footer or process for re-triggering if needed
            if (!entry.target.classList.contains('footer-slogan')) {
                observer.unobserve(entry.target);
            }
        }
    });
}, observerOptions);

// Mobile Dynamic Highlight (Spotlight Effect) - Singleton Logic
const spotlightOptions = {
    root: null,
    rootMargin: '-45% 0% -45% 0%', // Extremely narrow window (middle 10% of screen)
    threshold: 0
};

const spotlightObserver = new IntersectionObserver((entries) => {
    if (window.innerWidth > 1024) return; // Only for mobile/tablet

    entries.forEach(entry => {
        if (entry.isIntersecting) {
            // Remove focus from all other potential siblings before focusing this one
            document.querySelectorAll('.in-focus').forEach(el => {
                if (el !== entry.target) el.classList.remove('in-focus');
            });
            entry.target.classList.add('in-focus');

            // Special case for about section portrait
            if (entry.target.classList.contains('about-media')) {
                entry.target.querySelector('.about-portrait').style.filter = 'grayscale(0%)';
                entry.target.querySelector('.about-portrait').style.transform = 'scale(1)';
            }
        } else {
            entry.target.classList.remove('in-focus');
            if (entry.target.classList.contains('about-media')) {
                entry.target.querySelector('.about-portrait').style.filter = 'grayscale(100%)';
                entry.target.querySelector('.about-portrait').style.transform = 'scale(1.1)';
            }
        }
    });
}, spotlightOptions);

document.querySelectorAll('.reveal-on-scroll').forEach(element => {
    observer.observe(element);

    // Add spotlight to relevant cards for mobile
    if (element.classList.contains('project-item') ||
        element.classList.contains('service-item') ||
        element.classList.contains('process-step-v2') ||
        element.classList.contains('bento-item') ||
        element.classList.contains('about-media')) {
        spotlightObserver.observe(element);
    }
});

// Process Section Progress Line Logic
const processSection = document.querySelector('.process-section');
const progressLine = document.querySelector('.line-progress');
if (processSection && progressLine) {
    window.addEventListener('scroll', () => {
        const sectionRect = processSection.getBoundingClientRect();
        const sectionHeight = processSection.offsetHeight;
        const windowHeight = window.innerHeight;

        // Calculate progress based on scroll position relative to section
        // Starts when top of section is at 80% scroll, ends when bottom is at 20%
        let progress = (windowHeight * 0.8 - sectionRect.top) / (sectionHeight + windowHeight * 0.6);
        progress = Math.max(0, Math.min(1, progress));

        progressLine.style.height = `${progress * 100}%`;
    });
}

// Bento Grid Mouse Spotlight Logic
const bentoItems = document.querySelectorAll('.bento-item');
bentoItems.forEach(item => {
    item.addEventListener('mousemove', (e) => {
        const rect = item.getBoundingClientRect();
        const x = ((e.clientX - rect.left) / rect.width) * 100;
        const y = ((e.clientY - rect.top) / rect.height) * 100;
        item.style.setProperty('--mouse-x', `${x}%`);
        item.style.setProperty('--mouse-y', `${y}%`);
    });
});

// Enhanced Magnetic Effect for Buttons & Nav
const magneticElements = document.querySelectorAll('.magnetic-wrap');
if (magneticElements.length > 0) {
    magneticElements.forEach(item => {
        const link = item.querySelector('a, button');

        item.addEventListener('mousemove', (e) => {
            const rect = item.getBoundingClientRect();
            const x = e.clientX - rect.left - rect.width / 2;
            const y = e.clientY - rect.top - rect.height / 2;

            // Move the wrap slightly
            item.style.transform = `translate(${x * 0.3}px, ${y * 0.3}px)`;

            // Move the inner element further for "magnetic" pull
            if (link) {
                link.style.transform = `translate(${x * 0.5}px, ${y * 0.5}px)`;
            }
        });

        item.addEventListener('mouseleave', () => {
            item.style.transform = '';
            if (link) link.style.transform = '';
        });
    });
}

// Project Hover Inertia Logic
const projectItems = document.querySelectorAll('.project-item');
const hoverContainer = document.getElementById('projectHoverContainer');
const hoverImage = document.getElementById('projectHoverImage');

if (hoverContainer && projectItems.length > 0) {
    let mouseX = 0, mouseY = 0;
    let containerX = 0, containerY = 0;
    let isHovering = false;

    projectItems.forEach(item => {
        item.addEventListener('mouseenter', () => {
            const img = item.getAttribute('data-image');
            if (img && hoverImage) {
                hoverImage.src = img;
                hoverContainer.classList.add('active');
                isHovering = true;
            }
        });

        item.addEventListener('mouseleave', () => {
            hoverContainer.classList.remove('active');
            isHovering = false;
        });
    });

    window.addEventListener('mousemove', (e) => {
        mouseX = e.clientX;
        mouseY = e.clientY;
    });

    // Inertia calculation loop
    function animateHoverContainer() {
        const easing = 0.15;

        // Target position (offset to center cursor)
        const targetX = mouseX - 150;
        const targetY = mouseY - 100;

        containerX += (targetX - containerX) * easing;
        containerY += (targetY - containerY) * easing;

        hoverContainer.style.transform = `translate3d(${containerX}px, ${containerY}px, 0) scale(${isHovering ? 1 : 0.8})`;

        requestAnimationFrame(animateHoverContainer);
    }
    animateHoverContainer();
}

// Hero Description Card Tilt Effect
const heroCard = document.querySelector('.hero-description');
if (heroCard) {
    let cardRect = heroCard.getBoundingClientRect();
    window.addEventListener('resize', () => {
        cardRect = heroCard.getBoundingClientRect();
    });

    let mouseX = 0, mouseY = 0;
    let ticking = false;

    window.addEventListener('mousemove', (e) => {
        if (window.innerWidth <= 1024) return;
        mouseX = e.clientX;
        mouseY = e.clientY;
        if (!ticking) {
            window.requestAnimationFrame(() => {
                const cardX = cardRect.left + cardRect.width / 2;
                const cardY = cardRect.top + cardRect.height / 2;

                const angleX = (mouseY - cardY) / 30;
                const angleY = (cardX - mouseX) / 30;

                heroCard.style.transform = `rotateX(${angleX}deg) rotateY(${angleY}deg) translateY(-8px)`;
                ticking = false;
            });
            ticking = true;
        }
    });

    window.addEventListener('mouseleave', () => {
        heroCard.style.transform = `rotateX(0deg) rotateY(0deg) translateY(0px)`;
    });
}

// Hero Background Mouse Interaction
const meshGradient = document.querySelector('.mesh-gradient');
if (meshGradient) {
    let tickingMesh = false;
    window.addEventListener('mousemove', (e) => {
        if (!tickingMesh) {
            window.requestAnimationFrame(() => {
                const x = (e.clientX / window.innerWidth - 0.5) * 30;
                const y = (e.clientY / window.innerHeight - 0.5) * 30;
                meshGradient.style.transform = `translate3d(${x}px, ${y}px, 0) rotate(${x / 4}deg) scale(1.2)`;
                tickingMesh = false;
            });
            tickingMesh = true;
        }
    });
}

// Project Modal Logic
const modal = document.getElementById('projectModal');
const modalTitle = document.getElementById('modalTitle');
const modalCategory = document.getElementById('modalCategory');
const modalImage1 = document.getElementById('modalImage1');
const modalDescription = document.getElementById('modalDescription');
const modalImage2 = document.getElementById('modalImage2'); // Correct ID
const modalLinkBtn = document.getElementById('modalLinkBtn'); // Updated to match new ID
const modalClientText = document.getElementById('modalClientText');
const modalRoleText = document.getElementById('modalRoleText');
const modalChallengeText = document.getElementById('modalChallengeText');
const modalSolutionText = document.getElementById('modalSolutionText');
const closeModalBtn = document.querySelector('.close-button'); // Select by class

const projectData = {
    'E-Commerce Platform': {
        en: {
            title: "E-Commerce Platform",
            category: "Web Design / Dev",
            description: "A premium e-commerce platform built for high-scale fashion brands. Includes localized payments, dynamic inventory, and a custom design system.",
            client: "Adham Wael",
            role: "Lead Developer<br>UX Strategist",
            challenge: "Developing a system that handles thousands of concurrent users while maintaining a 99+ lighthouse performance score across all device types.",
            solution: "Utilized Next.js for server-side rendering and GSAP for high-end micro-interactions that don't compromise core web vitals."
        },
        ar: {
            title: "منصة تجارة إلكترونية",
            category: "تصميم ويب / تطوير",
            description: "منصة تجارة إلكترونية متميزة تم بناؤها لعلامات تجارية كبرى في مجال الأزياء. تشمل مدفوعات محلية، ومخزون ديناميكي، ونظام تصميم مخصص.",
            client: "أدهم الديب",
            role: "مطور أساسي<br>مخطط تجربة مستخدم",
            challenge: "تطوير نظام يتعامل مع آلاف المستخدمين المتزامنين مع الحفاظ على درجة أداء تفوق 99 في Lighthouse عبر جميع أنواع الأجهزة.",
            solution: "تم استخدام Next.js للعرض من جهة الخادم و GSAP للتفاعلات الدقيقة الراقية التي لا تؤثر على أساسيات الويب الحيوية."
        },
        image1: "Wide.jpg",
        link: "https://google.com",
        image2: "darris.jpg"
    },
    'Real Estate Website': {
        en: {
            title: "Real Estate Website",
            category: "Development",
            description: "A modern property listing platform with interactive maps and high-fidelity property walkthroughs.",
            client: "Luxe Realty",
            role: "Frontend Architect",
            challenge: "Integrating complex map APIs with custom-styled markers while ensuring the UI remains minimalist and fast.",
            solution: "Used Mapbox GL JS for the mapping engine and custom React hooks for state management of property filters."
        },
        ar: {
            title: "موقع عقارات",
            category: "تطوير",
            description: "منصة حديثة لإدراج العقارات مع خرائط تفاعلية وجولات عقارية عالية الدقة.",
            client: "Luxe Realty",
            role: "مهندس واجهات أمامية",
            challenge: "دمج واجهات برمجة تطبيقات الخرائط المعقدة مع علامات مخصصة مع ضمان بقاء واجهة المستخدم بسيطة وسريعة.",
            solution: "تم استخدام Mapbox GL JS لمحرك الخرائط وخطافات React المخصصة لإدارة حالة فلاتر العقارات."
        },
        image1: "darris.jpg",
        link: "#",
        image2: "Wide.jpg"
    },
    'Interactive Learning Website': {
        en: {
            title: "Interactive Learning Website",
            category: "Branding / Dev",
            description: "An educational platform focused on immersive learning experiences through interactive storytelling and gamified progress tracking.",
            client: "EduTech Global",
            role: "Creative Developer",
            challenge: "Managing complex state transitions between learning modules while keeping the visual experience cohesive and engaging.",
            solution: "Implemented a robust animation pipeline using GSAP timelines and a modular component architecture based on Next.js."
        },
        ar: {
            title: "موقع تعلم تفاعلي",
            category: "هوية تجارية / تطوير",
            description: "منصة تعليمية تركز على تجارب التعلم الغامرة من خلال سرد القصص التفاعلي وتتبع التقدم بأسلوب الألعاب.",
            client: "EduTech Global",
            role: "مطور إبداعي",
            challenge: "إدارة انتقالات الحالة المعقدة بين وحدات التعلم مع الحفاظ على التجربة البصرية متماسكة وجذابة.",
            solution: "تم تنفيذ خط أنابيب رسوم متحركة قوي باستخدام جداول زمنية لـ GSAP وبنية مكونات معيارية تعتمد على Next.js."
        },
        image1: "Wide.jpg",
        link: "#",
        image2: "darris.jpg"
    }
};


let lastMouseX = 0;
let lastMouseY = 0;
let velocityX = 0;
let velocityY = 0;

const projectHoverContainer = document.getElementById('projectHoverContainer');
const projectHoverImage = document.getElementById('projectHoverImage');

if (isMouseDevice && projectHoverContainer && projectHoverImage) {
    document.querySelectorAll('.project-item').forEach(item => {
        item.addEventListener('mouseenter', () => {
            const imageSrc = item.dataset.image;
            if (imageSrc && projectHoverContainer && projectHoverImage) {
                projectHoverImage.src = imageSrc;
                gsap.to(projectHoverContainer, {
                    opacity: 1,
                    scale: 1,
                    duration: 0.6,
                    ease: "power3.out"
                });
                gsap.to(projectHoverImage, {
                    scale: 1,
                    duration: 1.2,
                    ease: "power2.out"
                });

                // Show VIEW label
                if (follower) follower.classList.add('project-active');

                // Stagger tags
                const tags = item.querySelectorAll('.project-tags span');
                gsap.fromTo(tags,
                    { y: 10, opacity: 0 },
                    { y: 0, opacity: 1, stagger: 0.1, duration: 0.4, ease: "power2.out" }
                );
            }
        });

        item.addEventListener('mouseleave', () => {
            // Reset tags
            const tags = item.querySelectorAll('.project-tags span');
            gsap.to(tags, { y: 0, opacity: 0.5, duration: 0.3 });
            if (projectHoverContainer) {
                gsap.to(projectHoverContainer, {
                    opacity: 0,
                    scale: 0.8,
                    duration: 0.4,
                    ease: "power3.in"
                });
                gsap.to(projectHoverImage, {
                    scale: 1.2,
                    duration: 0.4
                });

                // Hide VIEW label
                if (follower) follower.classList.remove('project-active');
            }
        });

        item.addEventListener('mousemove', (e) => {
            const title = item.querySelector('.project-title');
            if (title) {
                const rect = item.getBoundingClientRect();
                const x = e.clientX - rect.left - rect.width / 2;
                const y = e.clientY - rect.top - rect.height / 2;

                gsap.to(title, {
                    x: x * 0.1,
                    y: y * 0.1,
                    duration: 0.4,
                    ease: "power2.out"
                });
            }
        });

        item.addEventListener('mouseleave', () => {
            const title = item.querySelector('.project-title');
            if (title) {
                gsap.to(title, { x: 0, y: 0, duration: 0.4, ease: "power2.out" });
            }
        });

        item.addEventListener('click', () => {
            const title = item.querySelector('.project-title').textContent.replace(/\s+/g, ' ').trim();

            let titleKey = '';
            for (const [key, data] of Object.entries(projectData)) {
                if (data.en.title === title || data.ar.title === title || key === title) {
                    titleKey = key;
                    break;
                }
            }

            const data = projectData[titleKey];
            const langData = data ? data[currentLang] : null;

            if (modalTitle) modalTitle.textContent = langData ? langData.title : title;
            if (modalCategory) modalCategory.textContent = langData ? langData.category : item.querySelector('.project-category').textContent.trim();

            if (data && langData) {
                if (modalDescription) modalDescription.textContent = langData.description;
                if (modalImage1) modalImage1.src = data.image1 || item.dataset.image;
                if (modalClientText) modalClientText.textContent = langData.client;
                if (modalRoleText) modalRoleText.innerHTML = langData.role;
                if (modalLinkBtn) modalLinkBtn.href = data.link;
                if (modalChallengeText) modalChallengeText.textContent = langData.challenge;
                if (modalSolutionText) modalSolutionText.textContent = langData.solution;

                if (modalImage2) {
                    if (data.image2) {
                        modalImage2.src = data.image2;
                        modalImage2.style.display = 'block';
                    } else {
                        modalImage2.style.display = 'none';
                    }
                }
            } else {
                if (modalDescription) modalDescription.textContent = currentLang === 'ar' ? "الباقي من تفاصيل المشروع قادمة قريباً." : "Project details coming soon.";
            }

            if (modal) {
                modal.classList.add('active');
                modal.scrollTop = 0;
            }

            // Lock background scroll correctly
            const scrollBarWidth = window.innerWidth - document.documentElement.clientWidth;
            document.body.style.paddingRight = `${scrollBarWidth}px`;
            document.body.style.overflow = 'hidden';

            if (typeof lenis !== 'undefined') lenis.stop();

            const projectSlug = titleKey.toLowerCase().replace(/\s+/g, '-');
            history.pushState({ project: titleKey }, '', `#project-${projectSlug}`);

            const revealElements = modal.querySelectorAll('.modal-title, .modal-category, .modal-description, .modal-sidebar, .modal-main');
            revealElements.forEach((el, i) => {
                el.style.opacity = '0';
                el.style.transform = 'translateY(20px)';
                el.style.transition = 'all 0.8s cubic-bezier(0.16, 1, 0.3, 1)';
                setTimeout(() => {
                    el.style.opacity = '1';
                    el.style.transform = 'translateY(0)';
                }, 400 + (i * 100));
            });
        });
    });
}

function closeModal() {
    if (!modal) return;
    modal.classList.remove('active');

    // Smooth transition back
    setTimeout(() => {
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
        if (typeof lenis !== 'undefined') lenis.start();
    }, 400); // Wait for modal animation to semi-clear

    if (window.location.hash.startsWith('#project-')) {
        history.pushState('', '', window.location.pathname + window.location.search);
    }
}

// Initial setup for project hover
if (projectHoverContainer) {
    gsap.set(projectHoverContainer, { xPercent: -50, yPercent: -50 });
}


if (modal) {
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeModal();
        }
    });

    if (closeModalBtn) {
        closeModalBtn.addEventListener('click', closeModal);
    }

    // New: Handle the footer close button as well
    const footerCloseBtn = modal.querySelector('.close-project-btn');
    if (footerCloseBtn) {
        footerCloseBtn.addEventListener('click', closeModal);
    }
}

// Handle browser back button
window.addEventListener('popstate', (e) => {
    if (modal && modal.classList.contains('active')) {
        closeModal();
    }
});

// New Premium Mobile Navigation Logic
const menuToggle = document.querySelector('.menu-toggle');
const mobileOverlay = document.querySelector('.mobile-nav-overlay');
const mobileLinks = document.querySelectorAll('.m-nav-link');
const mobileClose = document.querySelector('.mobile-nav-close');

if (menuToggle && mobileOverlay) {
    const closeMenu = () => {
        menuToggle.classList.remove('active');
        mobileOverlay.classList.remove('active');
        menuToggle.setAttribute('aria-expanded', 'false');
        document.body.style.overflow = '';
        if (typeof lenis !== 'undefined') lenis.start();
    };

    menuToggle.addEventListener('click', () => {
        const isActive = menuToggle.classList.toggle('active');
        mobileOverlay.classList.toggle('active');
        menuToggle.setAttribute('aria-expanded', isActive);

        if (isActive) {
            document.body.style.overflow = 'hidden';
            if (typeof lenis !== 'undefined') lenis.stop();
        } else {
            document.body.style.overflow = '';
            if (typeof lenis !== 'undefined') lenis.start();
        }
    });

    if (mobileClose) {
        mobileClose.addEventListener('click', closeMenu);
    }

    // Close menu when a link is clicked
    mobileLinks.forEach(link => {
        link.addEventListener('click', closeMenu);
    });
}

// Advanced Navbar Behavior
const header = document.querySelector('.site-header');
const progressBar = document.querySelector('.header-progress-bar');
const navTimeElements = document.querySelectorAll('.nav-time');

let lastScroll = 0;
window.addEventListener('scroll', () => {
    const currentScroll = window.pageYOffset;

    if (header) {
        // Sticky glass state
        if (currentScroll > 50) {
            header.classList.add('scrolled');
        } else {
            header.classList.remove('scrolled');
        }

    }
    lastScroll = currentScroll;

    const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
    const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
    const scrolled = (winScroll / height) * 100;
    if (progressBar) progressBar.style.width = scrolled + "%";

    const processSection = document.querySelector('.process-section');
    const lineProgress = document.querySelector('.line-progress');
    const processContainer = document.querySelector('.process-container');

    if (processSection && lineProgress && processContainer) {
        const sectionRect = processContainer.getBoundingClientRect();
        const sectionHeight = processContainer.offsetHeight;
        const windowHeight = window.innerHeight;
        const start = windowHeight * 0.8;
        let progress = 0;
        if (sectionRect.top < start) {
            progress = ((start - sectionRect.top) / sectionHeight) * 100;
        }
        lineProgress.style.height = Math.min(100, Math.max(0, progress)) + "%";
    }
});

function updateNavTime() {
    const now = new Date();
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');

    const translateNum = (num) => {
        if (currentLang !== 'ar') return num;
        const arabicNumbers = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
        // Remove leading zero if in Arabic
        let processedNum = num.toString().replace(/^0/, '');
        return processedNum.replace(/[0-9]/g, w => arabicNumbers[w]);
    };

    const timeStr = `${translateNum(hours)}:${translateNum(minutes)}`;
    navTimeElements.forEach(el => el.textContent = timeStr);
}
setInterval(updateNavTime, 1000);
updateNavTime();

// Estimate Calculator Logic
const estimateForm = document.getElementById('estimateForm');
const projectType = document.getElementById('projectType');
const pageCount = document.getElementById('pageCount');
const pageValue = document.getElementById('pageValue');
const addons = document.querySelectorAll('.addon');
const totalCostElement = document.getElementById('totalCost');

function calculateEstimate() {
    if (!projectType || !totalCostElement) return;
    let total = parseInt(projectType.value);
    let pages = parseInt(pageCount.value);
    if (pages > 1) {
        total += (pages - 1) * 100;
    }
    addons.forEach(addon => {
        if (addon.checked) {
            total += parseInt(addon.value);
        }
    });

    const translateNum = (num) => {
        if (currentLang !== 'ar') return num;
        const arabicNumbers = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
        return num.toString().replace(/[0-9]/g, w => arabicNumbers[w]);
    };
    totalCostElement.textContent = (currentLang === 'ar' ? '' : '$') + translateNum(total.toLocaleString()) + (currentLang === 'ar' ? '$' : '');
}

if (estimateForm) {
    projectType.addEventListener('change', calculateEstimate);
    pageCount.addEventListener('input', () => {
        const val = pageCount.value;
        const translateNum = (num) => {
            if (currentLang !== 'ar') return num;
            const arabicNumbers = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
            return num.toString().replace(/[0-9]/g, w => arabicNumbers[w]);
        };
        const suffix = currentLang === 'ar' ? (val == 1 ? ' صفحة' : ' صفحات') : (val == 1 ? ' Page' : ' Pages');
        pageValue.textContent = translateNum(val) + suffix;
        calculateEstimate();
    });
    addons.forEach(addon => {
        addon.addEventListener('change', calculateEstimate);
    });
    calculateEstimate();
}

// Smooth Scroll with Lenis
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const targetId = this.getAttribute('href').substring(1);
        if (modal && modal.classList.contains('active')) {
            modal.classList.remove('active');
            body.style.overflow = '';
        }
        if (targetId === "" || targetId === "home" || this.classList.contains('back-to-top')) {
            lenis.scrollTo(0);
            return;
        }
        const targetElement = document.getElementById(targetId);
        if (targetElement) {
            lenis.scrollTo(targetElement);
        }
    });
});

// Footer Clock
function updateClock() {
    const clockElement = document.querySelector('.clock-time');
    if (!clockElement) return;
    const now = new Date();
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');

    const translateNum = (num) => {
        if (currentLang !== 'ar') return num;
        const arabicNumbers = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
        let processedNum = num.toString().replace(/^0/, '');
        return processedNum.replace(/[0-9]/g, w => arabicNumbers[w]);
    };

    clockElement.textContent = `${translateNum(hours)}:${translateNum(minutes)}:${translateNum(seconds)}`;
}
setInterval(updateClock, 1000);
updateClock();

// Sophisticated Preloader
document.addEventListener('DOMContentLoaded', () => {
    const loader = document.getElementById('page-loader');
    const barFill = document.querySelector('.loader-bar-fill');
    const percentageText = document.querySelector('.loader-percentage');
    const statusText = document.querySelector('.loader-status');
    const letters = document.querySelectorAll('.loader-letter');
    if (!loader) return;
    const images = Array.from(document.querySelectorAll('img'));
    const totalAssets = images.length;
    let loadedAssets = 0;
    let targetProgress = 0;
    let currentProgress = 0;
    const statusMessages = [
        translations[currentLang].loader_msg1,
        translations[currentLang].loader_msg2,
        translations[currentLang].loader_msg3,
        translations[currentLang].loader_msg4,
        translations[currentLang].loader_msg5
    ];

    if (currentLang === 'ar') {
        const loaderText = document.querySelector('.loader-text');
        if (loaderText) {
            const arName = translations.ar.adham_name;
            // Split by words instead of characters to keep Arabic letters connected
            loaderText.innerHTML = arName.split(' ').map(word => `<span class="loader-letter">${word}</span>`).join('&nbsp;');
            const newLetters = loaderText.querySelectorAll('.loader-letter');
            newLetters.forEach((word, i) => {
                word.style.animationDelay = `${i * 0.2}s`;
            });
        }
    } else {
        letters.forEach((letter, i) => {
            letter.style.animationDelay = `${i * 0.05}s`;
        });
    }

    function trackImageLoading() {
        if (totalAssets === 0) {
            targetProgress = 100;
            return;
        }
        images.forEach(img => {
            if (img.complete) assetLoaded();
            else {
                img.addEventListener('load', assetLoaded);
                img.addEventListener('error', assetLoaded);
            }
        });
    }
    function assetLoaded() {
        loadedAssets++;
        targetProgress = (loadedAssets / totalAssets) * 100;
    }
    function updateLoaderAnimation() {
        currentProgress += (targetProgress - currentProgress) * 0.05 + 0.2;
        if (currentProgress >= 100) {
            currentProgress = 100;
            finishLoading();
        } else {
            if (barFill) barFill.style.width = `${currentProgress}%`;
            if (percentageText) percentageText.textContent = Math.floor(currentProgress).toString().padStart(2, '0');
            const messageIndex = Math.min(Math.floor((currentProgress / 100) * statusMessages.length), statusMessages.length - 1);
            if (statusText) statusText.textContent = statusMessages[messageIndex];
            requestAnimationFrame(updateLoaderAnimation);
        }
    }
    function finishLoading() {
        if (barFill) barFill.style.width = "100%";
        if (percentageText) percentageText.textContent = "100";
        if (statusText) statusText.textContent = translations[currentLang].loader_msg5;
        setTimeout(() => {
            loader.classList.add('page-loader--hide');
            document.body.classList.add('loaded');
            setTimeout(() => {
                document.querySelectorAll('.hero-section .reveal-element').forEach((el, i) => {
                    setTimeout(() => el.classList.add('is-visible'), i * 150);
                });
            }, 400);
        }, 800);
    }
    trackImageLoading();
    updateLoaderAnimation();
});

// Contact Form Submission
const contactForm = document.getElementById('contactForm');
if (contactForm) {
    contactForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const submitBtn = contactForm.querySelector('.submit-btn');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = `<span>${currentLang === 'ar' ? 'جاري الإرسال...' : 'Sending...'}</span><i class="fas fa-spinner fa-spin"></i>`;

        fetch('https://api.web3forms.com/submit', {
            method: 'POST',
            body: new FormData(contactForm)
        }).then(res => res.json()).then(data => {
            if (data.success) {
                submitBtn.innerHTML = `<span>${currentLang === 'ar' ? 'تم بنجاح' : 'Success'}</span><i class="fas fa-check"></i>`;
                contactForm.reset();
            } else {
                submitBtn.innerHTML = originalBtnText;
            }
        }).catch(() => {
            submitBtn.innerHTML = originalBtnText;
        }).finally(() => {
            submitBtn.disabled = false;
            setTimeout(() => { submitBtn.innerHTML = originalBtnText; }, 5000);
        });
    });
}

function switchLanguage(lang) {
    currentLang = lang;
    localStorage.setItem('preferredLang', lang);
    document.documentElement.lang = lang;
    document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';

    const translateNum = (num) => {
        if (lang !== 'ar') return num;
        const arabicNumbers = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
        // Remove leading zero if in Arabic
        let processedNum = num.toString().replace(/^0/, '');
        return processedNum.replace(/[0-9]/g, w => arabicNumbers[w]);
    };

    const langBtnText = document.querySelector('#lang-toggle .lang-text');
    const mLangBtnText = document.querySelector('#m-lang-toggle .lang-text');
    const targetLangLabel = lang === 'en' ? 'AR' : 'EN';
    if (langBtnText) langBtnText.textContent = targetLangLabel;
    if (mLangBtnText) mLangBtnText.textContent = targetLangLabel;

    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (translations[lang] && translations[lang][key]) {
            const countSpan = el.querySelector('.nav-count, .work-count');
            if (countSpan) {
                const countText = countSpan.textContent.replace(/[٠-٩]/g, m => "٠١٢٣٤٥٦٧٨٩".indexOf(m));
                countSpan.textContent = translateNum(countText);
                const countHTML = countSpan.outerHTML;
                const translatedBase = translations[lang][key];
                el.innerHTML = `${translatedBase} ${countHTML}`;
            } else {
                el.textContent = translations[lang][key];
            }
        }
    });

    document.querySelectorAll('.nav-count, .work-count, .project-number, .step-number-v2, .phi-num, .stat-number, .item-num, .stat-val, .loader-percentage').forEach(el => {
        let text = el.textContent.replace(/[٠-٩]/g, m => "٠١٢٣٤٥٦٧٨٩".indexOf(m));
        // Strip leading zero for Arabic counts
        if (lang === 'ar' && text.startsWith('0') && text.length > 1) {
            text = text.substring(1);
        }
        el.textContent = translateNum(text);
    });

    document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        if (translations[lang] && translations[lang][key]) el.placeholder = translations[lang][key];
    });

    document.querySelectorAll('.project-item').forEach(item => {
        const titleEl = item.querySelector('.project-title');
        const categoryEl = item.querySelector('.project-category');
        const currentTitle = titleEl.textContent.replace(/\s+/g, ' ').trim();
        for (const [key, data] of Object.entries(projectData)) {
            if (data.en.title === currentTitle || data.ar.title === currentTitle || key === currentTitle) {
                titleEl.innerHTML = data[lang].title.replace('\n', '<br>');
                categoryEl.textContent = data[lang].category;
                break;
            }
        }
    });

    if (pageValue) {
        const val = pageCount.value;
        const suffix = lang === 'ar' ? (val == 1 ? ' صفحة' : ' صفحات') : (val == 1 ? ' Page' : ' Pages');
        pageValue.textContent = translateNum(val) + suffix;
        calculateEstimate();
    }
    updateSlide(currentIndex);
    if (typeof updateNavTime === 'function') updateNavTime();
    if (typeof updateClock === 'function') updateClock();
    if (typeof initTextAnimations === 'function') initTextAnimations();
}

const langToggle = document.getElementById('lang-toggle');
const mLangToggle = document.getElementById('m-lang-toggle');

const toggleLang = () => {
    switchLanguage(currentLang === 'en' ? 'ar' : 'en');
};

if (langToggle) langToggle.addEventListener('click', toggleLang);
if (mLangToggle) mLangToggle.addEventListener('click', toggleLang);

switchLanguage(currentLang);

// Project Hash Routing Logic
function handleProjectHash() {
    const hash = window.location.hash;
    if (hash.startsWith('#project-')) {
        const slug = hash.replace('#project-', '');
        let projectFound = false;
        const projectItems = document.querySelectorAll('.project-item');

        projectItems.forEach(item => {
            const titleEl = item.querySelector('.project-title');
            if (!titleEl) return;
            const title = titleEl.textContent.replace(/\s+/g, ' ').trim();

            let titleKey = '';
            for (const [key, data] of Object.entries(projectData)) {
                if (data.en.title === title || data.ar.title === title || key === title) {
                    titleKey = key;
                    break;
                }
            }

            if (titleKey && titleKey.toLowerCase().replace(/\s+/g, '-') === slug) {
                projectFound = true;
                // Only click if modal isn't already active
                if (!modal || !modal.classList.contains('active')) {
                    setTimeout(() => {
                        item.click();
                    }, 500);
                }
            }
        });

        // Redirect if no matching project found
        if (!projectFound) {
            window.location.href = '404.html';
        }
    }
}

// Global listeners for project routing
document.addEventListener('DOMContentLoaded', handleProjectHash);
window.addEventListener('hashchange', handleProjectHash);

// Magnetic Wrap Effect - Desktop Only
const magneticWraps = document.querySelectorAll('.magnetic-wrap');

magneticWraps.forEach(wrap => {
    wrap.addEventListener('mousemove', (e) => {
        if (window.innerWidth <= 1024) return; // Disable on touch/tablet

        const rect = wrap.getBoundingClientRect();
        const x = e.clientX - rect.left - rect.width / 2;
        const y = e.clientY - rect.top - rect.height / 2;
        wrap.style.transform = `translate(${x * 0.4}px, ${y * 0.4}px)`;

        const link = wrap.querySelector('a');
        if (link) {
            link.style.transform = `translate(${x * 0.2}px, ${y * 0.2}px)`;
        }
    });

    wrap.addEventListener('mouseleave', () => {
        wrap.style.transform = 'translate(0, 0)';
        const link = wrap.querySelector('a');
        if (link) {
            link.style.transform = 'translate(0, 0)';
        }
    });
});

// Live Clock Functionality
function updateClocks() {
    const now = new Date();
    const options = {
        timeZone: 'Africa/Cairo',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
    };

    const timeString = new Intl.DateTimeFormat('en-GB', options).format(now);

    // Update Header Time (HH:MM)
    const headerTimeEl = document.querySelector('.nav-time');
    if (headerTimeEl) {
        headerTimeEl.textContent = timeString.substring(0, 5);
    }

    // Update Footer Clock (HH:MM:SS)
    const footerClockEl = document.querySelector('#footerClock .clock-time');
    if (footerClockEl) {
        footerClockEl.textContent = timeString;
    }
}

// Initial call and set interval
updateClocks();
setInterval(updateClocks, 1000);

// Custom Cursor Logic
const cursor = document.querySelector('.custom-cursor');
const follower = document.querySelector('.cursor-follower');

if (isMouseDevice && cursor && follower) {
    let mouseX = 0, mouseY = 0;

    window.addEventListener('mousemove', (e) => {
        // Sync both cursor and project hover coordinates
        mouseX = e.clientX;
        mouseY = e.clientY;

        // Calculate velocity for project hover tilt
        velocityX = mouseX - lastMouseX;
        velocityY = mouseY - lastMouseY;
        lastMouseX = mouseX;
        lastMouseY = mouseY;
    });

    // Use GSAP for smooth movement
    gsap.to({}, {
        duration: 0.016,
        repeat: -1,
        onRepeat: () => {
            // Cursor dot (instant)
            gsap.set(cursor, {
                x: mouseX,
                y: mouseY
            });

            // Cursor follower (smooth)
            gsap.to(follower, {
                duration: 0.5,
                x: mouseX,
                y: mouseY,
                ease: "power2.out"
            });

            // Project hover (lagging behind cursor for liquid feel)
            if (projectHoverContainer) {
                gsap.to(projectHoverContainer, {
                    x: mouseX,
                    y: mouseY,
                    rotate: velocityX * 0.2,
                    duration: 0.8,
                    ease: "power3.out",
                    overwrite: "auto"
                });
            }
        }
    });

    // Hover states
    document.querySelectorAll('a, button, .project-item, .magnetic-wrap, [role="button"]').forEach(el => {
        el.addEventListener('mouseenter', () => {
            follower.classList.add('active');
            // Fade out dot to focus on the expanded follower
            gsap.to(cursor, { opacity: 0, scale: 0, duration: 0.3 });
        });
        el.addEventListener('mouseleave', () => {
            follower.classList.remove('active');
            // Bring back the dot
            gsap.to(cursor, { opacity: 1, scale: 1, duration: 0.3 });
        });
    });

    // Click states
    window.addEventListener('mousedown', () => {
        follower.classList.add('clicking');
    });
    window.addEventListener('mouseup', () => {
        follower.classList.remove('clicking');
    });
}

// Manual Split Text & Reveal
function initTextAnimations() {
    const splitElements = document.querySelectorAll('.section-header h2');

    splitElements.forEach(el => {
        const key = el.getAttribute('data-i18n');
        let text = el.textContent;
        if (key && translations[currentLang][key]) {
            text = translations[currentLang][key];
        }

        el.innerHTML = '';
        el.style.display = 'flex';
        el.style.flexWrap = 'wrap';
        el.style.gap = '0'; // Use gap 0 and rely on spans/spaces
        el.style.overflow = 'hidden';

        const splitMethod = currentLang === 'ar' ? ' ' : '';
        const items = text.split(splitMethod);

        items.forEach((item, i) => {
            const span = document.createElement('span');
            if (currentLang === 'ar') {
                span.textContent = item;
            } else {
                span.textContent = item === ' ' ? '\u00A0' : item;
            }
            span.style.display = 'inline-block';
            span.style.transform = 'translateY(100%)';
            el.appendChild(span);

            // Add a proper space span for Arabic words
            if (currentLang === 'ar' && i !== items.length - 1) {
                const space = document.createElement('span');
                space.textContent = '\u00A0';
                space.style.display = 'inline-block';
                el.appendChild(space);
            }
        });

        // Trigger reveal if already in view or set up observer
        const reveal = () => {
            gsap.to(el.querySelectorAll('span'), {
                y: 0,
                duration: 1.2,
                stagger: currentLang === 'ar' ? 0.08 : 0.02,
                ease: "power4.out"
            });
        };

        if (el.classList.contains('is-visible')) {
            reveal();
        } else {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        el.classList.add('is-visible');
                        reveal();
                        observer.unobserve(el);
                    }
                });
            }, { threshold: 0.1 });
            observer.observe(el);
        }
    });
}

document.addEventListener('DOMContentLoaded', initTextAnimations);
